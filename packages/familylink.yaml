#################################################################
# Package: Google Family Link & Nintendo Switch Integratie
# Beschrijving: Beheer van schermtijd, verzoeken en statistieken
# Auteur: Jeroen & Home Assistant Architect
# Versie: 6.8 (Add: Geheugen voor Switch Etenstijd-logica)
#################################################################

# ----------------------------------------------------------------
# NIEUW: Geheugen voor Nintendo Switch Limieten
# Deze zijn nodig om de oude tijd te onthouden tijdens het eten.
# ----------------------------------------------------------------
input_number:
  mem_nintendo_switch_limit:
    name: Geheugen Switch Standaard
    min: -1
    max: 999
    mode: box
  mem_nintendo_switch_lite_limit:
    name: Geheugen Switch Lite
    min: -1
    max: 999
    mode: box
  mem_nintendo_switch_2_limit:
    name: Geheugen Switch 2
    min: -1
    max: 999
    mode: box

automation:
  # ----------------------------------------------------------------
  # 1. INTERACTIEF TIJD VERZOEK (Telegram)
  # ----------------------------------------------------------------
  - id: family_link_interactive_flow
    alias: "Family Link: Interactief Tijd Verzoek"
    description: "Handelt verzoeken om extra schermtijd af via interactieve Telegram knoppen."
    mode: parallel

    trigger:
      - platform: event
        event_type: telegram_command
        id: "cmd"
      - platform: event
        event_type: telegram_text
        id: "txt"
      - platform: event
        event_type: telegram_callback
        id: "callback"

    action:
      - variables:
          id_mika: !secret telegram_id_mika
          id_yulian: !secret telegram_id_yulian
          id_parents: !secret telegram_parents
          chat_id_test: !secret telegram_chatid_test
          chat_id_family: !secret telegram_chatid_family

          # Haal het Chat ID op
          current_chat_id: >-
            {% set d = trigger.event.data %}
            {% if d.chat_id is defined %}{{ d.chat_id }}
            {% elif d.message is defined and d.message.chat is defined %}{{ d.message.chat.id }}
            {% else %}0{% endif %}

          current_user_id: "{{ trigger.event.data.user_id | default(0) }}"

          # Naam van de afzender ophalen
          approver_name: >-
            {% set d = trigger.event.data %}
            {% if d.from_first is defined %}{{ d.from_first }}
            {% elif d.get('from', {}).first_name is defined %}{{ d.from.first_name }}
            {% else %}een ouder{% endif %}

      # Beveiliging: Alleen reageren in toegestane chats
      - condition: template
        value_template: >
          {{ current_chat_id | string == chat_id_test | string or 
             current_chat_id | string == chat_id_family | string }}

      - choose:
          # ======================================================
          # STAP 1: START (Command /tijd, Tekst "tijd" of Terug-knop)
          # ======================================================
          - conditions:
              - condition: or
                conditions:
                  - condition: template
                    value_template: "{{ trigger.id == 'cmd' and trigger.event.data.command.split('@')[0] == '/tijd' }}"
                  - condition: template
                    value_template: >
                      {{ trigger.id == 'txt' and trigger.event.data.text is defined and
                         (trigger.event.data.text | lower is search('tijd') or 
                          trigger.event.data.text | lower is search('minuten')) }}
                  - condition: template
                    value_template: "{{ trigger.id == 'callback' and trigger.event.data.data == '/start_request' }}"
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ trigger.id == 'callback' }}"
                then:
                  - action: telegram_bot.edit_message
                    data:
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      chat_id: "{{ current_chat_id }}"
                      message: "Voor welk apparaat wil je extra tijd?"
                      inline_keyboard:
                        - "ðŸ“± Telefoons/Tablets:/dev:select_fl, ðŸŽ® Nintendo Switch:/dev:switch_select"
                        - "Annuleren âŒ:/cancel"
                else:
                  - action: telegram_bot.send_message
                    data:
                      target: "{{ current_chat_id }}"
                      message: "Voor welk apparaat wil je extra tijd?"
                      inline_keyboard:
                        - "ðŸ“± Telefoons/Tablets:/dev:select_fl, ðŸŽ® Nintendo Switch:/dev:switch_select"
                        - "Annuleren âŒ:/cancel"

          # ------------------------------------------------------
          # STAP 1b: SELECTIE MENU FAMILY LINK
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'callback' and trigger.event.data.data == '/dev:select_fl' }}"
            sequence:
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ current_chat_id }}"
                  message: "Voor wie is de tijd bedoeld?"
                  inline_keyboard:
                    - "ðŸ“± Mika Telefoon:/dev:m_p, ðŸ“± Yulian Telefoon:/dev:y_p"
                    - "ðŸ“Ÿ Mika Tablet:/dev:m_t, ðŸ“Ÿ Yulian Tablet:/dev:y_t"
                    - "Terug â†©ï¸:/start_request, Annuleren âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"

          # ------------------------------------------------------
          # STAP 1c: SELECTIE MENU SWITCH (Welke console)
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'callback' and trigger.event.data.data == '/dev:switch_select' }}"
            sequence:
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ current_chat_id }}"
                  message: "Welke Nintendo Switch?"
                  inline_keyboard:
                    - "Switch (Standaard):/dev:sw_std, Switch Lite:/dev:sw_lite"
                    - "Switch 2:/dev:sw_2"
                    - "Terug â†©ï¸:/start_request, Annuleren âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"

          # ------------------------------------------------------
          # STAP 2: Family Link Tijd Kiezen
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: >
                  {{ trigger.id == 'callback' and trigger.event.data.data.startswith('/dev:') 
                     and trigger.event.data.data.split(':')[1] in ['m_p','m_t','y_p','y_t'] }}
            sequence:
              - variables:
                  code: "{{ trigger.event.data.data.split(':')[1] }}"
                  device_name: "{{ {'m_p':'Mika Telefoon','m_t':'Mika Tablet','y_p':'Yulian Telefoon','y_t':'Yulian Tablet'}[code] }}"
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ current_chat_id }}"
                  message: "Hoeveel tijd keuren de ouders goed voor **{{ device_name }}**?"
                  inline_keyboard:
                    - "15m:/add:{{code}}:15, 30m:/add:{{code}}:30, 1u:/add:{{code}}:60"
                    - "Terug â†©ï¸:/dev:select_fl, Afwijzen âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"

          # ------------------------------------------------------
          # STAP 2b: Switch Tijd Kiezen
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'callback' and trigger.event.data.data.startswith('/dev:sw_') }}"
            sequence:
              - variables:
                  code: "{{ trigger.event.data.data.split(':')[1] }}"
                  device_name: "{{ {'sw_std':'Nintendo Switch','sw_lite':'Switch Lite','sw_2':'Switch 2'}[code] }}"
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ current_chat_id }}"
                  message: "Hoeveel speeltijd voor de **{{ device_name }}**?"
                  inline_keyboard:
                    - "5m:/sw_add:{{code}}:5, 15m:/sw_add:{{code}}:15"
                    - "30m:/sw_add:{{code}}:30, 1u:/sw_add:{{code}}:60"
                    - "Onbeperkt â™¾ï¸:/sw_add:{{code}}:999"
                    - "Terug â†©ï¸:/dev:switch_select, Afwijzen âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"

          # ------------------------------------------------------
          # STAP 3: UITVOEREN (Family Link)
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'callback' and trigger.event.data.data.startswith('/add:') }}"
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ current_user_id | int in id_parents }}"
                then:
                  - variables:
                      payload: "{{ trigger.event.data.data.split(':') }}"
                      code: "{{ payload[1] }}"
                      minutes: "{{ payload[2] }}"
                      # CORRECTIE: Entity IDs
                      target_entity: "{{ {'m_p':'switch.mika_telefoon_family_link','m_t':'switch.mika_tablet_family_link','y_p':'switch.yulian_telefoon_family_link','y_t':'switch.yulian_tablet_family_link'}[code] }}"
                  - action: familylink.add_time_bonus
                    data:
                      entity_id: "{{ target_entity }}"
                      bonus_minutes: "{{ minutes }}"
                  - action: telegram_bot.edit_message
                    data:
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      chat_id: "{{ current_chat_id }}"
                      message: "âœ… **Goedgekeurd door {{ approver_name }}!**\nEr is {{ minutes }} min toegevoegd."
                      inline_keyboard: []
                else:
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "â›” Alleen ouders mogen dit!"
                      show_alert: true

          # ------------------------------------------------------
          # STAP 3b: UITVOEREN (Switches)
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'callback' and trigger.event.data.data.startswith('/sw_add:') }}"
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ current_user_id | int in id_parents }}"
                then:
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "Verwerken..."
                  - variables:
                      payload: "{{ trigger.event.data.data.split(':') }}"
                      code: "{{ payload[1] }}"
                      minutes: "{{ payload[2] | int }}"
                      prefix: "{{ 'switch' if code == 'sw_std' else ('switchlite' if code == 'sw_lite' else 'switch2') }}"
                      limit_entity: "number.console_nintendo_{{ prefix }}_max_screentime_today"
                      bedtime_entity: "time.console_nintendo_{{ prefix }}_bedtime_alarm"
                      suspend_entity: "switch.console_nintendo_{{ prefix }}_suspend_software"
                      current_limit: "{{ states(limit_entity) | int(0) if states(limit_entity) not in ['unknown','unavailable'] else 0 }}"
                  
                  - action: number.set_value
                    target: { entity_id: "{{ limit_entity }}" }
                    data: { value: "{{ -1 if minutes == 999 else (current_limit + minutes) }}" }
                  
                  - if: "{{ minutes == 999 }}"
                    then:
                      - action: switch.turn_off
                        target: { entity_id: "{{ suspend_entity }}" }
                    else:
                      - action: switch.turn_on
                        target: { entity_id: "{{ suspend_entity }}" }
                      - variables:
                          safe_bt: "{{ states(bedtime_entity) if states(bedtime_entity) not in ['unknown','unavailable'] else '19:00:00' }}"
                          new_bt: "{{ now() + timedelta(minutes=minutes) }}"
                      - if: "{{ new_bt > today_at(safe_bt) }}"
                        then:
                          - action: time.set_value
                            target: { entity_id: "{{ bedtime_entity }}" }
                            data: { time: "{{ new_bt.strftime('%H:%M:%S') }}" }

                  - action: telegram_bot.edit_message
                    data:
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      chat_id: "{{ current_chat_id }}"
                      message: "âœ… **Switch goedgekeurd door {{ approver_name }}!**\nTijd: {{ 'Onbeperkt' if minutes == 999 else minutes ~ ' min' }}."
                      inline_keyboard: []
                else:
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "â›” Alleen ouders mogen dit!"
                      show_alert: true

          # ------------------------------------------------------
          # STAP 4: Annuleren
          # ------------------------------------------------------
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'callback' and trigger.event.data.data == '/cancel' }}"
            sequence:
              - action: telegram_bot.delete_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ current_chat_id }}"

automation:
  # ----------------------------------------------------------------
  # 2. ETENSTIJD KNOP (Alles blokkeren/vrijgeven)
  # ----------------------------------------------------------------
  - id: family_link_dinner_time
    alias: "Family Link: Etenstijd Modus"
    initial_state: true
    mode: restart
    
    variables:
      # Haal parent IDs uit secrets
      id_parents: !secret telegram_parents
      # Bepaal naar welke groep we sturen (Test of Family) o.b.v. labels
      id_family: >-
        {%- if 'test' in labels(this.entity_id) | default([], true) -%}
          {{ states('input_text.telegram_chatid_test') }}
        {%- else -%}
          {{ states('input_text.telegram_chatid_family') }}
        {%- endif -%}

    trigger:
      - platform: event
        event_type: telegram_command
        id: "lock"
        event_data:
          command: "/eten"
      - platform: event
        event_type: telegram_command
        id: "unlock"
        event_data:
          command: "/klaar"

    condition:
      # Alleen ouders mogen dit commando geven
      - condition: template
        value_template: "{{ trigger.event.data.user_id | int in id_parents }}"
      # Alleen reageren in de juiste chatgroep
      - condition: template
        value_template: "{{ trigger.event.data.chat_id | string == id_family | string }}"

    action:
      - choose:
          # --- LOCK (/eten) ---
          # Doel: BLOKKEREN (Switch AAN = Gesloten/Locked)
          - conditions:
              - condition: trigger
                id: "lock"
            sequence:
              # 1. Family Link Switches AAN zetten (AAN = Geblokkeerd)
              - action: switch.turn_on
                target:
                  entity_id: 
                    - switch.mika_telefoon_family_link
                    - switch.mika_tablet_family_link
                    - switch.yulian_telefoon_family_link
                    - switch.yulian_tablet_family_link
                    - switch.yulian_tv_family_link
                    - switch.yulian_chromebook_family_link
              
              # 2. Nintendo: Huidige tijd opslaan in geheugen (zodat we het straks kunnen herstellen)
              - action: input_number.set_value
                target:
                  entity_id: input_number.mem_nintendo_switch_limit
                data:
                  value: "{{ states('number.console_nintendo_switch_max_screentime_today') | float(0) }}"
              - action: input_number.set_value
                target:
                  entity_id: input_number.mem_nintendo_switch_lite_limit
                data:
                  value: "{{ states('number.console_nintendo_switchlite_max_screentime_today') | float(0) }}"
              - action: input_number.set_value
                target:
                  entity_id: input_number.mem_nintendo_switch_2_limit
                data:
                  value: "{{ states('number.console_nintendo_switch2_max_screentime_today') | float(0) }}"

              # 3. Nintendo: Tijd op 0 zetten (forceer blokkade via Parental Controls)
              - action: number.set_value
                target:
                  entity_id: 
                    - number.console_nintendo_switch_max_screentime_today
                    - number.console_nintendo_switchlite_max_screentime_today
                    - number.console_nintendo_switch2_max_screentime_today
                data:
                  value: 0
              
              # 4. Bevestiging sturen
              - action: telegram_bot.send_message
                data:
                  target: "{{ id_family }}"
                  message: "ðŸ½ï¸ **Etenstijd!** Alle apparaten (incl. Switches en Chromebook) zijn gepauzeerd. Aan tafel!"

          # --- UNLOCK (/klaar) ---
          # Doel: VRIJGEVEN (Switch UIT = Beschikbaar/Unlocked)
          - conditions:
              - condition: trigger
                id: "unlock"
            sequence:
              # 1. Family Link Switches UIT zetten (UIT = Beschikbaar)
              - action: switch.turn_off
                target:
                  entity_id: 
                    - switch.mika_telefoon_family_link
                    - switch.mika_tablet_family_link
                    - switch.yulian_telefoon_family_link
                    - switch.yulian_tablet_family_link
                    - switch.yulian_tv_family_link
                    - switch.yulian_chromebook_family_link
              
              # 2. Nintendo: Tijd herstellen vanuit geheugen
              - action: number.set_value
                target:
                  entity_id: number.console_nintendo_switch_max_screentime_today
                data:
                  value: "{{ states('input_number.mem_nintendo_switch_limit') | float(0) }}"
              - action: number.set_value
                target:
                  entity_id: number.console_nintendo_switchlite_max_screentime_today
                data:
                  value: "{{ states('input_number.mem_nintendo_switch_lite_limit') | float(0) }}"
              - action: number.set_value
                target:
                  entity_id: number.console_nintendo_switch2_max_screentime_today
                data:
                  value: "{{ states('input_number.mem_nintendo_switch_2_limit') | float(0) }}"
              
              # 3. Bevestiging sturen
              - action: telegram_bot.send_message
                data:
                  target: "{{ id_family }}"
                  message: "âœ… Apparaten zijn weer vrijgegeven. Smakelijk gehad!"

  # ----------------------------------------------------------------
  # 3. DAGELIJKS OVERZICHT (Statistieken)
  # ----------------------------------------------------------------
  - id: family_link_daily_stats
    alias: "Family Link: Dagelijks Overzicht"
    trigger:
      - platform: time
        at: "21:00:00"
    action:
      - action: telegram_bot.send_message
        data:
          target: >-
            {%- if 'test' in labels(this.entity_id) | default([], true) -%}
              {{ states('input_text.telegram_chatid_test') }}
            {%- else -%}
              {{ states('input_text.telegram_chatid_family') }}
            {%- endif -%}
          message: >
            ðŸ“Š **Schermtijd Vandaag**
            
            **Mika (Totaal: {{ states('sensor.mika_steenhagen_screen_time_formatted') }})**
            1. {{ state_attr('sensor.mika_steenhagen_top_app_1', 'app_name') }}: {{ states('sensor.mika_steenhagen_top_app_1') | float | round(0) }} min
            2. {{ state_attr('sensor.mika_steenhagen_top_app_2', 'app_name') }}: {{ states('sensor.mika_steenhagen_top_app_2') | float | round(0) }} min
            3. {{ state_attr('sensor.mika_steenhagen_top_app_3', 'app_name') }}: {{ states('sensor.mika_steenhagen_top_app_3') | float | round(0) }} min
            
            **Yulian (Totaal: {{ states('sensor.yulian_steenhagen_screen_time_formatted') }})**
            1. {{ state_attr('sensor.yulian_steenhagen_top_app_1', 'app_name') }}: {{ states('sensor.yulian_steenhagen_top_app_1') | float | round(0) }} min
            2. {{ state_attr('sensor.yulian_steenhagen_top_app_2', 'app_name') }}: {{ states('sensor.yulian_steenhagen_top_app_2') | float | round(0) }} min
            3. {{ state_attr('sensor.yulian_steenhagen_top_app_3', 'app_name') }}: {{ states('sensor.yulian_steenhagen_top_app_3') | float | round(0) }} min

            **Nintendo Switch**
            - Standaard: {{ states('sensor.console_nintendo_switch_used_screen_time') }} min (Resterend: {{ states('sensor.console_nintendo_switch_screen_time_remaining') }})
            - Lite: {{ states('sensor.console_nintendo_switchlite_used_screen_time') }} min (Resterend: {{ states('sensor.console_nintendo_switchlite_screen_time_remaining') }})
            - Switch 2: {{ states('sensor.console_nintendo_switch2_used_screen_time') }} min (Resterend: {{ states('sensor.console_nintendo_switch2_screen_time_remaining') }})

  # ----------------------------------------------------------------
  # 4. NINTENDO SWITCH OCHTEND RESET
  # ----------------------------------------------------------------
  - id: family_link_nintendo_reset
    alias: "Family Link: Nintendo Switch Reset"
    description: "Reset speellimieten (vandaag) en bedtijden (voor morgen) om 06:00."
    trigger:
      - platform: time
        at: "06:00:00"
    action:
      # -----------------------------------------------------------
      # STAP 4.1: Haal agenda-info op voor MORGEN (tbv bedtijd)
      # We checken twee kalenders: Vakanties en Feestdagen
      # -----------------------------------------------------------
      - action: calendar.get_events
        target:
          entity_id: calendar.ical_vakantie
        data:
          start_date_time: "{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 00:00:00') }}"
          end_date_time: "{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 23:59:59') }}"
        response_variable: agenda_vakantie_morgen

      - action: calendar.get_events
        target:
          entity_id: calendar.nederland
        data:
          start_date_time: "{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 00:00:00') }}"
          end_date_time: "{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 23:59:59') }}"
        response_variable: agenda_feestdag_morgen

      # -----------------------------------------------------------
      # STAP 4.2: SPEELTIJD (Gebaseerd op VANDAAG via sensor)
      # -----------------------------------------------------------
      - choose:
          # Als VANDAAG vrij is -> 4 uur (240 min)
          - conditions:
              - condition: state
                entity_id: binary_sensor.status_vrij_vakantie_of_weekend
                state: "on"
            sequence:
              - action: number.set_value
                target:
                  entity_id: [number.console_nintendo_switch_max_screentime_today, number.console_nintendo_switchlite_max_screentime_today, number.console_nintendo_switch2_max_screentime_today]
                data:
                  value: 240
        default:
          # Anders -> 2 uur (120 min)
          - action: number.set_value
            target:
              entity_id: [number.console_nintendo_switch_max_screentime_today, number.console_nintendo_switchlite_max_screentime_today, number.console_nintendo_switch2_max_screentime_today]
            data:
              value: 120

      # -----------------------------------------------------------
      # STAP 4.3: BEDTIJD (Gebaseerd op MORGEN)
      # -----------------------------------------------------------
      - choose:
          - conditions:
              - condition: or
                conditions:
                  # A: Vandaag is Vrijdag (4) of Zaterdag (5) -> Morgen is weekend
                  - condition: template
                    value_template: "{{ now().weekday() in [4, 5] }}"
                  # B: Er staat voor morgen iets in de vakantiekalender
                  - condition: template
                    value_template: "{{ agenda_vakantie_morgen['calendar.ical_vakantie'].events | count > 0 }}"
                  # C: Er staat voor morgen iets in de feestdagenkalender
                  - condition: template
                    value_template: "{{ agenda_feestdag_morgen['calendar.nederland'].events | count > 0 }}"
            sequence:
              # Morgen vrij/weekend -> Late bedtijd (21:00)
              - action: time.set_value
                target:
                  entity_id: [time.console_nintendo_switch_bedtime_alarm, time.console_nintendo_switchlite_bedtime_alarm, time.console_nintendo_switch2_bedtime_alarm]
                data:
                  time: "21:00:00"
        default:
          # Morgen school/werk -> Vroege bedtijd (19:00)
          - action: time.set_value
            target:
              entity_id: [time.console_nintendo_switch_bedtime_alarm, time.console_nintendo_switchlite_bedtime_alarm, time.console_nintendo_switch2_bedtime_alarm]
            data:
              time: "19:00:00"