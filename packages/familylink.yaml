#################################################################
# Package: Google Family Link & Nintendo Switch Integratie
# Beschrijving: Beheer van schermtijd, verzoeken en statistieken
# Auteur: Jeroen & Home Assistant Architect
# Versie: 5.0 (Fix: Variable Scoping & Etenstijd triggers)
#################################################################

automation:
  # ----------------------------------------------------------------
  # 1. INTERACTIEF TIJD VERZOEK (Telegram)
  # ----------------------------------------------------------------
  - id: family_link_interactive_flow
    alias: "Family Link: Interactief Tijd Verzoek"
    description: "Handelt verzoeken om extra schermtijd af via interactieve Telegram knoppen."
    mode: parallel
    
    variables:
      id_mika: !secret telegram_id_mika
      id_yulian: !secret telegram_id_yulian
      id_parents: !secret telegram_parents
      # Dynamische Chat ID met witruimte-strip (robuust)
      id_family: >-
        {%- if 'test' in labels(this.entity_id) | default([], true) -%}
          {{ states('input_text.telegram_chatid_test') }}
        {%- else -%}
          {{ states('input_text.telegram_chatid_family') }}
        {%- endif -%}
      approver_name: "{{ trigger.event.data.from_first_name | default('een ouder', true) }}"

    trigger:
      - platform: event
        event_type: telegram_command
        id: "start_request"
      - platform: event
        event_type: telegram_text
        id: "start_request"
      - platform: event
        event_type: telegram_callback
        id: "callback"

    action:
      - choose:
          # ------------------------------------------------------
          # STAP 1: Start Verzoek (Vraag welk apparaat)
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "start_request"
              # Check: Bericht in de juiste groep
              - condition: template
                value_template: "{{ trigger.event.data.chat_id | string == id_family | string }}"
              # Check: Is het het juiste commando (/tijd OF /tijd@bot) OF tekst
              - condition: or
                conditions:
                  - condition: template
                    value_template: >
                      {{ trigger.event.event_type == 'telegram_command' and 
                         trigger.event.data.command is defined and
                         trigger.event.data.command.split('@')[0] == '/tijd' }}
                  - condition: template
                    value_template: >
                      {{ trigger.event.event_type == 'telegram_text' and 
                         ('tijd' in trigger.event.data.text | lower or 'minuten' in trigger.event.data.text | lower) }}
            sequence:
              - choose:
                  # Mika
                  - conditions:
                      - condition: template
                        value_template: "{{ trigger.event.data.user_id | string == id_mika | string }}"
                    sequence:
                      - action: telegram_bot.send_message
                        data:
                          target: "{{ id_family }}"
                          message: "Mika, voor welk apparaat wil je tijd?"
                          inline_keyboard:
                            - "ðŸ“± Mijn Telefoon:/dev:m_p, ðŸ“Ÿ Mijn Tablet:/dev:m_t"
                            - "ðŸŽ® Nintendo Switch:/dev:switch_select"
                            - "Annuleren âŒ:/cancel"
                  # Yulian
                  - conditions:
                      - condition: template
                        value_template: "{{ trigger.event.data.user_id | string == id_yulian | string }}"
                    sequence:
                      - action: telegram_bot.send_message
                        data:
                          target: "{{ id_family }}"
                          message: "Yulian, voor welk apparaat wil je tijd?"
                          inline_keyboard:
                            - "ðŸ“± Mijn Telefoon:/dev:y_p, ðŸ“Ÿ Mijn Tablet:/dev:y_t"
                            - "ðŸŽ® Nintendo Switch:/dev:switch_select"
                            - "Annuleren âŒ:/cancel"
                default:
                  - action: telegram_bot.send_message
                    data:
                      target: "{{ id_family }}"
                      message: "Voor wie en welk apparaat is de extra tijd?"
                      inline_keyboard:
                        - "ðŸ“± Mika Telefoon:/dev:m_p, ðŸ“± Yulian Telefoon:/dev:y_p"
                        - "ðŸ“Ÿ Mika Tablet:/dev:m_t, ðŸ“Ÿ Yulian Tablet:/dev:y_t"
                        - "ðŸŽ® Nintendo Switch:/dev:switch_select"
                        - "Annuleren âŒ:/cancel"

          # ------------------------------------------------------
          # STAP 1b: Switch Selectie Menu
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "callback"
              - condition: template
                value_template: "{{ trigger.event.data.data == '/dev:switch_select' }}"
            sequence:
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ trigger.event.data.message.chat.id }}"
                  message: "Welke Nintendo Switch?"
                  inline_keyboard:
                    - "Switch (Standaard):/dev:sw_std, Switch Lite:/dev:sw_lite"
                    - "Switch 2:/dev:sw_2"
                    - "Terug â†©ï¸:/start_request, Annuleren âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"
                  message: "Kies een console."

          # ------------------------------------------------------
          # STAP 2: Apparaat gekozen (Telefoons/Tablets)
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "callback"
              - condition: template
                value_template: "{{ trigger.event.data.data.startswith('/dev:') and not trigger.event.data.data.startswith('/dev:sw_') and trigger.event.data.data != '/dev:switch_select' }}"
            sequence:
              - variables:
                  code: "{{ trigger.event.data.data.split(':')[1] }}"
                  device_name: >-
                    {%- if code == 'm_p' -%}Mika's Telefoon
                    {%- elif code == 'm_t' -%}Mika's Tablet
                    {%- elif code == 'y_p' -%}Yulian's Telefoon
                    {%- elif code == 'y_t' -%}Yulian's Tablet
                    {%- endif -%}
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ trigger.event.data.message.chat.id }}"
                  message: "Verzoek voor **{{ device_name }}**.\nOuders, hoeveel tijd keuren jullie goed?"
                  inline_keyboard:
                    - "15m:/add:{{code}}:15, 30m:/add:{{code}}:30, 1u:/add:{{code}}:60"
                    - "Afwijzen âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"
                  message: "Keuze doorgegeven aan ouders."

          # ------------------------------------------------------
          # STAP 2b: Apparaat gekozen (Switches)
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "callback"
              - condition: template
                value_template: "{{ trigger.event.data.data.startswith('/dev:sw_') }}"
            sequence:
              - variables:
                  code: "{{ trigger.event.data.data.split(':')[1] }}"
                  device_name: >-
                    {%- if code == 'sw_std' -%}Nintendo Switch
                    {%- elif code == 'sw_lite' -%}Switch Lite
                    {%- elif code == 'sw_2' -%}Switch 2
                    {%- endif -%}
              - action: telegram_bot.edit_message
                data:
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  chat_id: "{{ trigger.event.data.message.chat.id }}"
                  message: "Verzoek voor **{{ device_name }}**.\nOuders, hoeveel speeltijd?"
                  inline_keyboard:
                    - "5m:/sw_add:{{code}}:5, 15m:/sw_add:{{code}}:15"
                    - "30m:/sw_add:{{code}}:30, 1u:/sw_add:{{code}}:60"
                    - "Onbeperkt â™¾ï¸:/sw_add:{{code}}:999"
                    - "Afwijzen âŒ:/cancel"
              - action: telegram_bot.answer_callback_query
                data:
                  callback_query_id: "{{ trigger.event.data.id }}"
                  message: "Opties getoond."

          # ------------------------------------------------------
          # STAP 3: Tijd Goedkeuren (Telefoons/Tablets)
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "callback"
              - condition: template
                value_template: "{{ trigger.event.data.data.startswith('/add:') }}"
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ trigger.event.data.user_id | int in id_parents }}" 
                then:
                  - variables:
                      code: "{{ trigger.event.data.data.split(':')[1] }}"
                      minutes: "{{ trigger.event.data.data.split(':')[2] | int }}"
                      target_entity: >-
                        {%- if code == 'm_p' -%}switch.sm_a176b
                        {%- elif code == 'm_t' -%}switch.lenovo_tb_x606f_van_mika
                        {%- elif code == 'y_p' -%}switch.sm_a145r
                        {%- elif code == 'y_t' -%}switch.tablet_yulian
                        {%- endif -%}
                      device_display: >-
                        {%- if code == 'm_p' -%}Mika's Telefoon
                        {%- elif code == 'm_t' -%}Mika's Tablet
                        {%- elif code == 'y_p' -%}Yulian's Telefoon
                        {%- elif code == 'y_t' -%}Yulian's Tablet
                        {%- endif -%}
                  
                  - action: familylink.add_time_bonus
                    data:
                      entity_id: "{{ target_entity }}"
                      bonus_minutes: "{{ minutes }}"
                  
                  - action: telegram_bot.edit_message
                    data:
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      chat_id: "{{ trigger.event.data.message.chat.id }}"
                      message: "âœ… **Goedgekeurd door {{ approver_name }}!**\nEr is {{ minutes }} minuten toegevoegd aan {{ device_display }}."
                      inline_keyboard: []
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "Tijd succesvol toegevoegd!"
                else:
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "â›” Alleen papa of mama mogen dit goedkeuren!"
                      show_alert: true

          # ------------------------------------------------------
          # STAP 3b: Tijd Goedkeuren (Switches)
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "callback"
              - condition: template
                value_template: "{{ trigger.event.data.data.startswith('/sw_add:') }}"
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ trigger.event.data.user_id | int in id_parents }}" 
                then:
                  # 1. Feedback (stop draaiend rondje)
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "Verwerken..."

                  # 2. Variabelen bepalen (Template-based, dus globaal beschikbaar in dit blok)
                  - variables:
                      code: "{{ trigger.event.data.data.split(':')[1] | trim }}"
                      minutes: "{{ trigger.event.data.data.split(':')[2] | int }}"
                      
                      limit_entity: >-
                        {%- if code == 'sw_std' -%}number.switch_max_screentime_today
                        {%- elif code == 'sw_lite' -%}number.switch_lite_max_screentime_today
                        {%- elif code == 'sw_2' -%}number.switch_2_max_screentime_today
                        {%- endif -%}
                      
                      bedtime_entity: >-
                        {%- if code == 'sw_std' -%}time.switch_bedtime_alarm_2
                        {%- elif code == 'sw_lite' -%}time.switch_lite_bedtime_alarm_2
                        {%- elif code == 'sw_2' -%}time.switch_2_bedtime_alarm_2
                        {%- endif -%}
                      
                      device_display: >-
                        {%- if code == 'sw_std' -%}Nintendo Switch
                        {%- elif code == 'sw_lite' -%}Switch Lite
                        {%- elif code == 'sw_2' -%}Switch 2
                        {%- endif -%}

                      # Huidige waarden ophalen
                      current_limit: "{{ states(limit_entity) | int(0) }}"
                      current_bedtime_str: "{{ states(bedtime_entity) | default('19:00:00', true) }}"
                      is_unlimited: "{{ minutes == 999 }}"
                      
                      # Nieuwe limiet berekenen (1440 min = 24 uur)
                      new_limit: "{{ 1440 if is_unlimited else (current_limit + minutes) }}"

                  # 3. Update de speellimiet
                  - action: number.set_value
                    target:
                      entity_id: "{{ limit_entity }}"
                    data:
                      value: "{{ new_limit | int }}"

                  # 4. Update de bedtijd (indien nodig of onbeperkt)
                  - if:
                      - condition: template
                        value_template: "{{ is_unlimited }}"
                    then:
                      - action: time.set_value
                        target:
                          entity_id: "{{ bedtime_entity }}"
                        data:
                          time: "23:59:00"
                    else:
                      - variables:
                          new_end_time: "{{ now() + timedelta(minutes=minutes) }}"
                          current_bedtime_dt: "{{ today_at(current_bedtime_str) }}"
                      # Alleen bedtijd verlengen als de nieuwe tijd later is dan de huidige bedtijd
                      - if:
                          - condition: template
                            value_template: "{{ new_end_time > current_bedtime_dt }}"
                        then:
                          - action: time.set_value
                            target:
                              entity_id: "{{ bedtime_entity }}"
                            data:
                              time: "{{ new_end_time.strftime('%H:%M:%S') }}"

                  # 5. Bevestiging in Telegram
                  - action: telegram_bot.edit_message
                    data:
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      chat_id: "{{ trigger.event.data.message.chat.id }}"
                      message: >
                        âœ… **Switch Update door {{ approver_name }}!**
                        Apparaat: {{ device_display }}
                        {% if is_unlimited %}
                        Status: â™¾ï¸ Onbeperkt spelen (limiet verwijderd, bedtijd 23:59)
                        {% else %}
                        Extra tijd: {{ minutes }} min
                        Nieuwe limiet: {{ new_limit }} min
                        {% endif %}
                      inline_keyboard: []

                else:
                  - action: telegram_bot.answer_callback_query
                    data:
                      callback_query_id: "{{ trigger.event.data.id }}"
                      message: "â›” Alleen ouders mogen dit goedkeuren!"
                      show_alert: true

          # ------------------------------------------------------
          # STAP 4: Annuleren
          # ------------------------------------------------------
          - conditions:
              - condition: trigger
                id: "callback"
              - condition: template
                value_template: "{{ trigger.event.data.data == '/cancel' }}"
            sequence:
               - action: telegram_bot.delete_message
                 data:
                   message_id: "{{ trigger.event.data.message.message_id }}"
                   chat_id: "{{ trigger.event.data.message.chat.id }}"

  # ----------------------------------------------------------------
  # 2. ETENSTIJD KNOP (Alles blokkeren/vrijgeven)
  # ----------------------------------------------------------------
  - id: family_link_dinner_time
    alias: "Family Link: Etenstijd Modus"
    variables:
      id_parents: !secret telegram_parents
      # Dynamische chat ID ook hier toepassen
      id_family: >-
        {%- if 'test' in labels(this.entity_id) | default([], true) -%}
          {{ states('input_text.telegram_chatid_test') }}
        {%- else -%}
          {{ states('input_text.telegram_chatid_family') }}
        {%- endif -%}
      
    trigger:
      # Generieke triggers om @botnaam filters op te vangen
      - platform: event
        event_type: telegram_command
        id: "lock"
      - platform: event
        event_type: telegram_command
        id: "unlock"
    
    condition:
      # Check 1: Is het een ouder?
      - condition: template
        value_template: "{{ trigger.event.data.user_id | int in id_parents }}"
      # Check 2: Is het bericht in de juiste chat?
      - condition: template
        value_template: "{{ trigger.event.data.chat_id | string == id_family | string }}"
        
    action:
      - choose:
          # --- LOCK (/eten) ---
          - conditions:
              - condition: trigger
                id: "lock"
              # Check op commando /eten (met eventuele suffix)
              - condition: template
                value_template: "{{ trigger.event.data.command.split('@')[0] == '/eten' }}"
            sequence:
              - action: switch.turn_off
                target:
                  # FIX: Inline lijst
                  entity_id: [switch.sm_a176b, switch.lenovo_tb_x606f_van_mika, switch.sm_a145r, switch.tablet_yulian, switch.switch_suspend_software, switch.switch_lite_suspend_software, switch.switch_2_suspend_software]
              - action: telegram_bot.send_message
                data:
                  target: "{{ id_family }}"
                  message: "ðŸ½ï¸ **Etenstijd!** Alle apparaten (incl. Switches) zijn gepauzeerd. Aan tafel!"

          # --- UNLOCK (/klaar) ---
          - conditions:
              - condition: trigger
                id: "unlock"
              # Check op commando /klaar (met eventuele suffix)
              - condition: template
                value_template: "{{ trigger.event.data.command.split('@')[0] == '/klaar' }}"
            sequence:
              - action: switch.turn_on
                target:
                  # FIX: Inline lijst
                  entity_id: [switch.sm_a176b, switch.lenovo_tb_x606f_van_mika, switch.sm_a145r, switch.tablet_yulian, switch.switch_suspend_software, switch.switch_lite_suspend_software, switch.switch_2_suspend_software]
              - action: telegram_bot.send_message
                data:
                  target: "{{ id_family }}"
                  message: "âœ… Apparaten zijn weer vrijgegeven. Smakelijk gehad!"

  # ----------------------------------------------------------------
  # 3. DAGELIJKS OVERZICHT (Statistieken)
  # ----------------------------------------------------------------
  - id: family_link_daily_stats
    alias: "Family Link: Dagelijks Overzicht"
    trigger:
      - platform: time
        at: "21:00:00"
    action:
      - action: telegram_bot.send_message
        data:
          target: >-
            {%- if 'test' in labels(this.entity_id) | default([], true) -%}
              {{ states('input_text.telegram_chatid_test') }}
            {%- else -%}
              {{ states('input_text.telegram_chatid_family') }}
            {%- endif -%}
          message: >
            ðŸ“Š **Schermtijd Vandaag**
            
            **Mika (Totaal: {{ states('sensor.mika_steenhagen_screen_time_formatted') }})**
            1. {{ state_attr('sensor.mika_steenhagen_top_app_1', 'app_name') }}: {{ states('sensor.mika_steenhagen_top_app_1') | float | round(0) }} min
            2. {{ state_attr('sensor.mika_steenhagen_top_app_2', 'app_name') }}: {{ states('sensor.mika_steenhagen_top_app_2') | float | round(0) }} min
            3. {{ state_attr('sensor.mika_steenhagen_top_app_3', 'app_name') }}: {{ states('sensor.mika_steenhagen_top_app_3') | float | round(0) }} min
            
            **Yulian (Totaal: {{ states('sensor.yulian_steenhagen_screen_time_formatted') }})**
            1. {{ state_attr('sensor.yulian_steenhagen_top_app_1', 'app_name') }}: {{ states('sensor.yulian_steenhagen_top_app_1') | float | round(0) }} min
            2. {{ state_attr('sensor.yulian_steenhagen_top_app_2', 'app_name') }}: {{ states('sensor.yulian_steenhagen_top_app_2') | float | round(0) }} min
            3. {{ state_attr('sensor.yulian_steenhagen_top_app_3', 'app_name') }}: {{ states('sensor.yulian_steenhagen_top_app_3') | float | round(0) }} min

            **Nintendo Switch**
            - Standaard: {{ states('sensor.switch_used_screen_time_2') }} min (Resterend: {{ states('sensor.switch_screen_time_remaining') }})
            - Lite: {{ states('sensor.switch_lite_used_screen_time_2') }} min (Resterend: {{ states('sensor.switch_lite_screen_time_remaining') }})
            - Switch 2: {{ states('sensor.switch_2_used_screen_time_2') }} min (Resterend: {{ states('sensor.switch_2_screen_time_remaining') }})

  # ----------------------------------------------------------------
  # 4. NINTENDO SWITCH OCHTEND RESET
  # ----------------------------------------------------------------
  - id: family_link_nintendo_reset
    alias: "Family Link: Nintendo Switch Reset"
    description: "Reset speellimieten en bedtijden van Switches om 06:00 afhankelijk van de dag."
    trigger:
      - platform: time
        at: "06:00:00"
    action:
      - choose:
          # --- WEEKEND (Za/Zo) ---
          - conditions:
              - condition: time
                weekday:
                  - sat
                  - sun
            sequence:
              # 3 Uur (180 min) speeltijd
              - action: number.set_value
                target:
                  entity_id: [number.switch_max_screentime_today, number.switch_lite_max_screentime_today, number.switch_2_max_screentime_today]
                data:
                  value: 180
              # Eindtijd 20:00
              - action: time.set_value
                target:
                  entity_id: [time.switch_bedtime_alarm_2, time.switch_lite_bedtime_alarm_2, time.switch_2_bedtime_alarm_2]
                data:
                  time: "20:00:00"

        # --- WEEKDAG (Ma-Vr) ---
        default:
          # 2 Uur (120 min) speeltijd
          - action: number.set_value
            target:
              entity_id: [number.switch_max_screentime_today, number.switch_lite_max_screentime_today, number.switch_2_max_screentime_today]
            data:
              value: 120
          # Eindtijd 19:00
          - action: time.set_value
            target:
              entity_id: [time.switch_bedtime_alarm_2, time.switch_lite_bedtime_alarm_2, time.switch_2_bedtime_alarm_2]
            data:
              time: "19:00:00"