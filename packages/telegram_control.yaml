telegram_bot:
  - platform: polling
    api_key: !secret telegram_api_key
    allowed_chat_ids:
      - !secret telegram_chatid_family
      - !secret telegram_chatid_test
      - !secret telegram_id_jeroen
      - !secret telegram_id_mika
      - !secret telegram_id_yulian
      - !secret telegram_id_linda

automation:
  # ----------------------------------------------------------------------------
  # 1. HOOFDMENU
  # ----------------------------------------------------------------------------
  - alias: "Telegram - Toon Huis Menu"
    id: "telegram_main_menu"
    trigger:
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/menu"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/start"
    action:
      - action: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          title: "ğŸ¡ **Huize Steenhagen**"
          message: "Kies een verdieping of actie:"
          inline_keyboard:
            - "ğŸšï¸ Zolder:/f:Zolder"
            - "ğŸ›ï¸ 1e Verdieping:/f:1e Verdieping"
            - "ğŸ›‹ï¸ Begane Grond:/f:Begane Grond"
            - "ğŸ“Š Status:/status, ğŸ¬ Scenes:/scenes"

  # ----------------------------------------------------------------------------
  # 2. LOGICA & ACTIES
  # ----------------------------------------------------------------------------
  - alias: "Telegram - Callback Handler"
    id: "telegram_callback_handler"
    trigger:
      - platform: event
        event_type: telegram_callback
    action:
      # Directe feedback om 'loading' icoon te stoppen
      - action: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "Verwerken..."

      - variables:
          parts: "{{ trigger.event.data.data.split(':') }}"
          cmd: "{{ parts[0] }}"
          target: "{{ parts[1] if parts|length > 1 else '' }}"
          extra: "{{ parts[2] if parts|length > 2 else '' }}"

      - choose:
          # --- STAP 1: KIES KAMER ---
          - conditions: "{{ cmd == '/f' }}"
            sequence:
              - variables:
                  rooms: >
                    {% if target == 'Zolder' %} ['Zolder']
                    {% elif target == '1e Verdieping' %} ['Slaapkamer', 'Kantoor', 'Slaapkamer Yulian']
                    {% elif target == 'Begane Grond' %} ['Woonkamer', 'Eetkamer', 'Serre', 'Keuken', 'Schuur']
                    {% else %} [] {% endif %}
              
              - action: telegram_bot.edit_message
                data:
                  chat_id: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  title: "ğŸ“ {{ target }}"
                  message: "Kies een kamer:"
                  inline_keyboard: >
                    {% set ns = namespace(buttons=[]) %}
                    {% for room in rooms %}
                      {% set ns.buttons = ns.buttons + ["ğŸšª " ~ room ~ ":/r:" ~ room ~ ":" ~ target] %}
                    {% endfor %}
                    {{ ns.buttons + ["ğŸ”™ Terug:/menu_cmd"] }}

          # --- STAP 2: KIES APPARAAT (Dynamisch) ---
          - conditions: "{{ cmd == '/r' }}"
            sequence:
              - variables:
                  entities: "{{ area_entities(target) or area_entities(target|lower|replace(' ','_')) }}"
              
              - if: "{{ entities == none or entities | count == 0 }}"
                then:
                  - action: telegram_bot.edit_message
                    data:
                      chat_id: "{{ trigger.event.data.chat_id }}"
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      message: "âš ï¸ Geen apparaten in '{{ target }}'."
                      inline_keyboard: ["ğŸ”™ Terug:/f:{{ extra }}"]
                else:
                  - action: telegram_bot.edit_message
                    data:
                      chat_id: "{{ trigger.event.data.chat_id }}"
                      message_id: "{{ trigger.event.data.message.message_id }}"
                      title: "ğŸ’¡ {{ target }}"
                      message: "Bediening:"
                      inline_keyboard: >
                        {% set ns = namespace(buttons=[]) %}
                        {# Filter en sorteer apparaten #}
                        {% set devs = expand(entities) 
                           | selectattr('domain', 'in', ['light','switch','media_player','cover','lock']) 
                           | sort(attribute='name') %}
                        
                        {% for dev in devs %}
                          {% set icon = 'ğŸŸ¡' if dev.state == 'on' else 'âš«' %}
                          
                          {# --- COVER LOGICA (ROLLUIKEN) --- #}
                          {# Hier strippen we de naam en tonen we alleen status #}
                          {% if 'cover' in dev.entity_id %}
                            {% if dev.state == 'open' %}
                               {% set label = 'ğŸªŸ Open' %}
                            {% elif dev.state == 'closed' %}
                               {% set label = 'ğŸŒš Dicht' %}
                            {% else %}
                               {% set label = 'â³ ' ~ dev.state %}
                            {% endif %}
                          
                          {# --- SLOTEN --- #}
                          {% elif 'lock' in dev.entity_id %}
                             {% set icon = 'ğŸ”’' if dev.state == 'locked' else 'ğŸ”“' %}
                             {% set label = icon ~ " " ~ dev.name %}

                          {# --- OVERIGE (Lampen etc) --- #}
                          {% else %}
                             {% set label = icon ~ " " ~ dev.name %}
                          {% endif %}
                          
                          {# Knop toevoegen #}
                          {% set ns.buttons = ns.buttons + [label ~ ":/t:" ~ dev.entity_id ~ ":" ~ target] %}
                        {% endfor %}
                        
                        {{ ns.buttons + ["ğŸ”™ Terug:/f:" ~ extra, "ğŸ  Menu:/menu_cmd"] }}

          # --- STAP 3: TOGGLE ACTIE ---
          - conditions: "{{ cmd == '/t' }}"
            sequence:
              - action: homeassistant.toggle
                target:
                  entity_id: "{{ target }}"
              - delay: "00:00:01" 
              
              # Menu verversen (Exacte kopie van logica hierboven)
              - action: telegram_bot.edit_message
                data:
                  chat_id: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  message: "Status bijgewerkt:"
                  inline_keyboard: >
                    {% set entities = area_entities(extra) or area_entities(extra|lower|replace(' ','_')) %}
                    {% set ns = namespace(buttons=[]) %}
                    {% set devs = expand(entities) 
                           | selectattr('domain', 'in', ['light','switch','media_player','cover','lock']) 
                           | sort(attribute='name') %}

                    {% for dev in devs %}
                          {% set icon = 'ğŸŸ¡' if dev.state == 'on' else 'âš«' %}
                          
                          {% if 'cover' in dev.entity_id %}
                            {% if dev.state == 'open' %}
                               {% set label = 'ğŸªŸ Open' %}
                            {% elif dev.state == 'closed' %}
                               {% set label = 'ğŸŒš Dicht' %}
                            {% else %}
                               {% set label = 'â³ ' ~ dev.state %}
                            {% endif %}
                          {% elif 'lock' in dev.entity_id %}
                             {% set icon = 'ğŸ”’' if dev.state == 'locked' else 'ğŸ”“' %}
                             {% set label = icon ~ " " ~ dev.name %}
                          {% else %}
                             {% set label = icon ~ " " ~ dev.name %}
                          {% endif %}
                          
                          {% set ns.buttons = ns.buttons + [label ~ ":/t:" ~ dev.entity_id ~ ":" ~ extra] %}
                    {% endfor %}
                    {{ ns.buttons + ["ğŸ”™ Terug:/f:Begane Grond", "ğŸ  Menu:/menu_cmd"] }}

          # --- NAVIGATIE & HULP ---
          - conditions: "{{ cmd == '/menu_cmd' }}"
            sequence:
              - action: telegram_bot.edit_message
                data:
                  chat_id: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  title: "ğŸ¡ Huize Steenhagen"
                  message: "Kies een verdieping:"
                  inline_keyboard:
                    - "ğŸšï¸ Zolder:/f:Zolder"
                    - "ğŸ›ï¸ 1e Verdieping:/f:1e Verdieping"
                    - "ğŸ›‹ï¸ Begane Grond:/f:Begane Grond"
                    - "ğŸ“Š Status:/status, ğŸ¬ Scenes:/scenes"
          
          - conditions: "{{ cmd == '/status' }}"
            sequence:
              - action: telegram_bot.edit_message
                data:
                  chat_id: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  message: "ğŸŒ¡ï¸ Woonkamer: {{ states('sensor.thuis_temperatuur') }}Â°C"
                  inline_keyboard: ["ğŸ”™:/menu_cmd"]

          - conditions: "{{ cmd == '/scenes' }}"
            sequence:
              - action: telegram_bot.edit_message
                data:
                  chat_id: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id }}"
                  message: "Scenes:"
                  inline_keyboard:
                    - "ğŸ˜´ Jeroen Slaapt:/call:automation.trigger:automation.jeroen_slaapt"
                    - "ğŸ”™:/menu_cmd"

          - conditions: "{{ cmd == '/call' }}"
            sequence:
               - action: "{{ target }}"
                 target:
                   entity_id: "{{ extra }}"

  # ----------------------------------------------------------------------------
  # 3. ASSIST AI (Fallback voor getypte tekst)
  # ----------------------------------------------------------------------------
  - alias: "Telegram - Assist AI"
    id: "telegram_assist_ai"
    trigger:
      - platform: event
        event_type: telegram_text
    condition:
      - condition: template
        value_template: "{{ not trigger.event.data.text.startswith('/') }}"
    action:
      - action: telegram_bot.send_chat_action
        data:
          target: "{{ trigger.event.data.chat_id }}"
          action: typing
      - action: conversation.process
        data:
          text: "{{ trigger.event.data.text }}"
          language: "nl"
        response_variable: agent
      - action: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          message: "{{ agent.response.speech.plain.speech }}"